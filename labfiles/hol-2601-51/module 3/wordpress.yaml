formatVersion: 2
inputs:
  namespace:
    type: string
    $data: /data/namespaces?projectId={{project}}
resources:
  SupervisorNamespace:
    type: CCI.Supervisor.Namespace
    properties:
      name: ${input.namespace}
      existing: true
  mysql-pvc:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: mysql-pvc
          labels:
            app: wordpress
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: cluster-wld01-01a-vsan-storage-policy
          resources:
            requests:
              storage: 5Gi
  wordpress-pvc:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: wordpress-pvc
          labels:
            app: wordpress
        spec:
          accessModes:
            - ReadWriteOnce
          storageClassName: cluster-wld01-01a-vsan-storage-policy
          resources:
            requests:
              storage: 5Gi
  mysql-pass:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: v1
        data:
          password: YWRtaW4= #admin base64 encoded
        kind: Secret
        metadata:
          name: mysql-pass
  mysql-service:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: v1
        kind: Service
        metadata:
          name: wordpress-mysql
          labels:
            app: wordpress
        spec:
          ports:
            - port: 3306
          selector:
            app: wordpress
            tier: mysql
          clusterIP: None
  wordpress-service:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: v1
        kind: Service
        metadata:
          name: wordpress
          labels:
            app: wordpress
        spec:
          ports:
            - port: 80
          selector:
            app: wordpress
            tier: frontend
          type: LoadBalancer
  wordpress-deployment:
    type: CCI.Supervisor.Resource
    dependsOn:
      - mysql-deployment
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: wordpress
          labels:
            app: wordpress
        spec:
          selector:
            matchLabels:
              app: wordpress
              tier: frontend
          strategy:
            type: Recreate
          template:
            metadata:
              labels:
                app: wordpress
                tier: frontend
            spec:
              containers:
                - image: registry.site-a.vcf.lab/wordpress
                  name: wordpress
                  env:
                    - name: WORDPRESS_DB_HOST
                      value: wordpress-mysql
                    - name: WORDPRESS_DB_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: mysql-pass
                          key: password
                  ports:
                    - containerPort: 80
                      name: wordpress
                  volumeMounts:
                    - name: wordpress-persistent-storage
                      mountPath: /var/www/html
              volumes:
                - name: wordpress-persistent-storage
                  persistentVolumeClaim:
                    claimName: wordpress-pvc
  mysql-deployment:
    type: CCI.Supervisor.Resource
    properties:
      context: ${resource.SupervisorNamespace.id}
      manifest:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: wordpress-mysql
          labels:
            app: wordpress
        spec:
          replicas: 1
          strategy:
            type: Recreate
          selector:
            matchLabels:
              app: wordpress
              tier: mysql
          template:
            metadata:
              labels:
                app: wordpress
                tier: mysql
            spec:
              containers:
                - image: registry.site-a.vcf.lab/mysql
                  name: mysql
                  resources:
                    limits:
                      memory: 1024Mi
                  env:
                    - name: MYSQL_ROOT_PASSWORD
                      valueFrom:
                        secretKeyRef:
                          name: mysql-pass
                          key: password
                  ports:
                    - containerPort: 3306
                      name: mysql
                  volumeMounts:
                    - name: mysql-persistent-storage
                      mountPath: /var/lib/mysql
              volumes:
                - name: mysql-persistent-storage
                  persistentVolumeClaim:
                    claimName: mysql-pvc
